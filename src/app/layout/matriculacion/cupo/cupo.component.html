<div class="row">
    <div class="col-lg-12">
        <table class="table table-responsive table-sm">
            <tr>
                <td>
                    <span [ngClass]="{'text-danger':periodoLectivoSeleccionado.estado!='ACTUAL',
                    'text-success':periodoLectivoSeleccionado.estado=='ACTUAL'}" class="form-control">
                        <strong>{{txtPeridoActualHistorico}} :</strong>
                    </span>
                </td>
                <td>
                    <select [disabled]="flagAsignaturasCupo" name="periodoLectivoActual"
                            [(ngModel)]="periodoLectivoActual.id" class="form-control"
                            (change)="cambiarPeriodoLectivoActual();getDetalleMatriculasForMalla()">
                        <option [ngClass]="{'bg-success text-white':periodo.estado=='ACTUAL'}" value="{{periodo.id}}"
                                *ngFor="let periodo of periodosLectivos">{{periodo.nombre}}</option>
                    </select>
                </td>
                <td>
                    <select [disabled]="flagAsignaturasCupo" [(ngModel)]="carrera.id" class="form-control"
                            id="carrera" name="carrera" required (change)="getCupos(1);getDetalleMatriculasForMalla()">
                        <option value="0" selected>SELECCIONE UNA CARRERA</option>
                        <option value="{{carrera.id}}" *ngFor="let carrera of carreras" class="small"
                                [ngClass]="{'bg-warning':carrera.descripcion=='MALLA ANTIGUA','text-white':carrera.descripcion=='MALLA ANTIGUA'}">
                            {{ carrera.descripcion }}
                        </option>
                    </select>
                </td>
                <td>
                    <select [disabled]="flagAsignaturasCupo" [(ngModel)]="periodoAcademico" class="form-control"
                            id="periodoAcademico" name="periodoAcademico" required
                            (change)="getCupos(1)">
                        <option value="-1" selected>SELECCIONE NIVEL</option>
                        <option value="" selected>TODOS</option>
                        <option value="{{periodoAcademico.id}}" *ngFor="let periodoAcademico of peridoAcademicos"
                                class="small">
                            {{periodoAcademico.nombre}}
                        </option>
                    </select>
                </td>
            </tr>
        </table>
    </div>
</div>
<!--Buscador-->
<div class="row" *ngIf="!flagAsignaturasCupo && carrera.id!=0">
    <div class="col-lg-12 col-xs-12 mt-1">
        <table class="table table-sm table-responsive">
            <tbody>
            <tr>
                <td *ngIf="periodoLectivoSeleccionado.estado=='ACTUAL'">
                    <label for="file-upload" class="btn btn-light fa fa-upload btn-sm form-control-sm"
                           title="Subir archivo de cupos" [ngClass]="{'disabled':false}">
                        <!--                           [title]="!((periodoLectivoSeleccionado.fecha_fin_anulacion|date:'yyyy-MM-dd')<-->
                        <!--                            (fechaActual|date:'yyyy-MM-dd'))?'Está  fuera del tiempo '-->
                        <!--                            +'('+periodoLectivoSeleccionado.fecha_inicio_cupo+' - '+periodoLectivoSeleccionado.fecha_fin_cupo+')'-->
                        <!--                            :'Desertar Estudiante'"-->

                        Subir cupos
                    </label>
                    <input id="file-upload" type="file" style='display: none;' [(ngModel)]="archivoTemp"
                           name="fileExcel"
                           (change)="uploadCupos($event)"
                           accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                    <!--                           [disabled]="-->
                    <!--                           !(-->
                    <!--                           (periodoLectivoSeleccionado.fecha_inicio_cupo|date:'yyyy-MM-dd')<=(fechaActual|date:'yyyy-MM-dd')-->
                    <!--                           &&-->
                    <!--                           (fechaActual|date:'yyyy-MM-dd')<=(periodoLectivoSeleccionado.fecha_fin_cupo|date:'yyyy-MM-dd')-->
                    <!--                           )"-->

                </td>
                <td *ngIf="carrera.id!=0 && periodoLectivoSeleccionado.estado=='ACTUAL'">
                    <button type="button" class="btn btn-light btn-sm form-control-sm"
                            (click)="validateCuposPeriodoAcademico()"
                            title="Aprobar todos los cupos del periodo académico">
                        <span class="fa fa-check"> Aprobar cupos por periodo</span>
                    </button>
                </td>
                <td *ngIf="periodoLectivoSeleccionado.estado=='ACTUAL'">
                    <button type="button" class="btn btn-light btn-sm form-control-sm"
                            (click)="validateCuposCarrera()"
                            title="Aprobar todos los cupos de la carrera"
                    >
                        <span class="fa fa-check"> Aprobar cupos por carrera</span>
                    </button>
                </td>
                <td *ngIf="periodoLectivoSeleccionado.estado=='ACTUAL'">
                    <button type="button" class="btn btn-light btn-sm form-control-sm"
                            (click)="deleteCuposPeriodoAcademico()"
                            title="Eliminar todos los cupos del periodo académico">
                        <span class="fa fa-trash"> Cupos por periodo</span>
                    </button>
                </td>
                <td *ngIf="carrera.id!=0">
                    <button type="button" class="btn btn-light btn-sm form-control-sm"
                            (click)="deleteCuposCarrera()"
                            title="Eliminar todos los cupos de la carrera"
                            *ngIf="periodoLectivoSeleccionado.estado=='ACTUAL'">
                        <span class="fa fa-trash"> Cupos por carrera</span>
                    </button>
                </td>
                <td *ngIf="carrera.id!=0">
                    <button type="button" class="btn btn-light btn-sm form-control-sm"
                            (click)="exportCuposCarrera()"
                            title="Descargar todos los cupos de la carrera">
                        <span class="fa fa-download"> Cupos por carrera</span>
                    </button>
                </td>
                <td>
                    <button type="button" class="btn btn-light btn-sm form-control-sm"
                            (click)="exportCuposPeriodo()"
                            title="Descargar todos los cupos del periodo académico">
                        <span class="fa fa-download"> Cupos por periodo</span>
                    </button>
                </td>
                <td>
                    <a class="fa fa-download btn btn-light btn-sm form-control-sm"
                       href="assets/formats/archivo_carga_cupos.xlsx"
                       target="_blank"
                       title="Formato para carga de cupos">
                        Formato cupos
                    </a>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="row" *ngIf="!flagAsignaturasCupo && carrera.id!=0">
    <div class="col-lg-4 col-xs-12 mt-1">
        <div class="input-group mb-3">
            <input type="text" class="form-control text-uppercase" id="buscador" name="buscador" [(ngModel)]="buscador"
                   (keyup)="filter($event)"
                   placeholder="Identificación, Apellido o Nombre">
            <div class="input-group-prepend">
                <span class="btn input-group-text fa fa-search" id="basic-addon-buscar" (click)="filter($event)"></span>
            </div>
        </div>
    </div>
</div>

<!--Tabla cupos-->
<div class="row mt-1" *ngIf="!flagAsignaturasCupo && carrera.id!=0">
    <div class="col-lg-12">
        <table class="table table-responsive table-hover">
            <thead class="table-default text-center">
            <th width="10%">Indetificación</th>
            <th width="33%">Apellidos y Nombres</th>
            <th width="15%">Tipo Matrícula</th>
            <th width="10%">Periodo</th>
            <th width="10%">Jornada</th>
            <th width="10%">Estado</th>
            <th width="12%">

            </th>
            </thead>
            <tbody>
            <tr *ngFor="let cupo of cupos">
                <td>
                    {{cupo.estudiante.identificacion}}
                </td>
                <td>
                    {{cupo.estudiante.apellido1 + ' ' + cupo.estudiante.apellido2 + ' ' + cupo.estudiante.nombre1 + ' ' +
                cupo.estudiante.nombre2}}
                </td>
                <td>
                    <select [(ngModel)]="cupo.tipo_matricula.id" class="text-uppercase form-control-sm"
                            [disabled]="!((cupo.estado=='EN_PROCESO' || cupo.estado=='APROBADO')&&periodoLectivoSeleccionado.estado=='ACTUAL')"
                            id="tipoMatricula" name="tipoMatricula" required
                            (change)="updateMatricula(cupo,'Tipo Matricula')">
                        <option value="{{tipoMatricula.id}}" *ngFor="let tipoMatricula of tiposMatricula">
                            {{tipoMatricula.nombre}}
                        </option>
                    </select>
                </td>
                <td class="text-uppercase">
                    <select name="periodoAcademicoPrincipal" id="periodoAcademicoPrincipal"
                            [(ngModel)]="cupo.periodo_academico.id" class="text-uppercase form-control-sm"
                            [disabled]="!((cupo.estado=='EN_PROCESO' || cupo.estado=='APROBADO')&&periodoLectivoSeleccionado.estado=='ACTUAL')"
                            (change)="updateMatricula(cupo,'Periodo Academico')">
                        <option value={{periodo.id}}
                                *ngFor="let periodo of peridoAcademicos">{{periodo.nombre}}</option>
                    </select>
                </td>
                <td>
                    <select name="jornadaPrincipal" id="jornadaPrincipal" [(ngModel)]="cupo.jornada"
                            class="text-uppercase form-control-sm"
                            [disabled]="!((cupo.estado=='EN_PROCESO' || cupo.estado=='APROBADO')&&periodoLectivoSeleccionado.estado=='ACTUAL')"
                            (change)="updateMatricula(cupo,'Jornada Principal')">
                        <option value={{jornada.codigo}}
                                *ngFor="let jornada of jornadas">{{jornada.descripcion}}</option>
                    </select>
                </td>
                <td>
                    {{cupo.estado}}
                </td>
                <td class="text-center">
                    <button type="button" class="btn ml-1 btn-sm" (click)="validateCupo(cupo)" title="Aprobar"
                            [ngClass]="{'btn-success':cupo.estado=='APROBADO','btn-primary':cupo.estado=='EN_PROCESO'}"
                            [disabled]="cupo.estado=='APROBADO' || cupo.estado=='MATRICULADO'"
                            *ngIf="cupo.estado=='EN_PROCESO'">

                        <span class="{{messages['buttonCheck']['icon']}}"></span>
                    </button>
                    <button type="button" class="btn btn-warning ml-1 btn-sm text-white"
                            (click)="getDetalleMatricula(cupo)" title="Asignaturas">
                <span class="{{messages['buttonUpdate']['icon']}}">

                </span>
                    </button>
                    <button type="button" class="btn btn-danger ml-1 btn-sm" (click)="deleteCupo(cupo)"
                            title="Eliminar"
                            *ngIf="(cupo.estado=='EN_PROCESO' || cupo.estado=='APROBADO') && periodoLectivoSeleccionado.estado=='ACTUAL'">
                        <span class="{{messages['buttonDelete']['icon']}}"></span>
                    </button>
                    <button type="button" class="btn btn-secondary ml-1 btn-sm" (click)="desertMatricula(cupo)"
                            [disabled]="!((periodoLectivoSeleccionado.fecha_fin_anulacion|date:'yyyy-MM-dd')<(fechaActual|date:'yyyy-MM-dd'))"
                            [title]="!((periodoLectivoSeleccionado.fecha_fin_anulacion|date:'yyyy-MM-dd')<
                            (fechaActual|date:'yyyy-MM-dd'))?'Está  fuera del tiempo':'Desertar Estudiante'">
                        <span class="{{messages['buttonDesert']['icon']}}"></span>
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!--Cupos totales y paginacion-->
<div class="row" *ngIf="!flagAsignaturasCupo && carrera.id!=0 && flagPagination ">
    <div class="col-lg-2">
        <h6>
            MATRICULADOS: {{total_detalle_matriculas_matriculados}}
        </h6>
        <h6>
            APROBADOS: {{total_detalle_matriculas_aprobados}}
        </h6>
    </div>
    <div class="col-lg-2">
        <h6>
            EN PROCESO: {{total_detalle_matriculas_en_proceso}}
        </h6>
        <h6>
            ANULADOS: {{total_detalle_matriculas_anulados}}
        </h6>
    </div>
    <div class="col-lg-6">
        <nav>
            <ul class="pagination">
                <li class="page-item">
                    <a class="page-link bg-dark text-white" href="javascript:void(0)" tabindex="-1"
                       (click)="firstPagina()">First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="javascript:void(0)" tabindex="-1"
                       (click)="paginacion(false)">Previous</a>
                </li>
                <li class="page-item " [ngClass]="{'active':page === actual_page}"
                    *ngFor="let page of total_pages_pagination"
                    (click)="getCupos(page)">
                    <a class="page-link" href="javascript:void(0)">{{page}}</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="javascript:void(0)" (click)="paginacion(true)">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link bg-dark text-white" href="javascript:void(0)"
                       (click)="lastPagina()">Last</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!--Detalle matricula-->
<div class="row mt-3" *ngIf="flagAsignaturasCupo">
    <div class="col-lg-12">
        <h1>
            <button type="button" class="btn btn-warning btn-lg mb-1" (click)="cambiarEstadoFlagAsignaturasCupo()">
                <span class="fa fa-arrow-left text-white"> Regresar</span>
            </button>
            {{matriculaSeleccionada.estudiante.apellido1 + ' ' + matriculaSeleccionada.estudiante.apellido2 + ' '
        + matriculaSeleccionada.estudiante.nombre1 + ' ' + matriculaSeleccionada.estudiante.nombre2}}
        </h1>

        <table class="table table-hover table-sm table-responsive">
            <thead class="table-default text-center">
            <th width="35%">Asignatura</th>
            <th width="15%">Número Matrícula</th>
            <th width="13%">Jornada</th>
            <th width="17%">Tipo Matrícula</th>
            <th width="10%">Estado</th>
            <th width="10%">
                <button type="button" class="btn btn-success ml-1 btn-sm"
                        (click)="openDetalleMatricula(contentDetalleMatricula)"
                        *ngIf="matriculaSeleccionada.estado=='EN_PROCESO' || matriculaSeleccionada.estado=='APROBADO'"
                        title="Añadir nueva asignatura">
                <span class="{{messages['buttonAdd']['icon']}}">
                  {{messages['buttonAdd']['text']}}
                </span>
                </button>
            </th>
            </thead>
            <tbody>
            <tr *ngFor="let detalle of detalleMatricula">
                <td>
                    <select [(ngModel)]="detalle.asignatura.id" class="form-control"
                            id="detalleAsignatura" name="detalleAsignatura" required
                            [disabled]="!((detalle.estado=='EN_PROCESO' || detalle.estado=='APROBADO')&&periodoLectivoSeleccionado.estado=='ACTUAL')"
                            (change)="updateDetalleMatricula(detalle,'Asignatura')">
                        <option value="{{asignatura.id}}" *ngFor="let asignatura of asignaturas">
                            {{asignatura.periodo_academico.id + ' ' + asignatura.nombre}}
                        </option>
                    </select>
                </td>
                <td>
                    <select [(ngModel)]="detalle.numero_matricula" class="form-control"
                            id="numero_matricula" name="numero_matricula" required
                            [disabled]="!((detalle.estado=='EN_PROCESO' || detalle.estado=='APROBADO')&&periodoLectivoSeleccionado.estado=='ACTUAL')"
                            (change)="updateDetalleMatricula(detalle,'Numero Matricula')">
                        <option value="{{numeroMatricula.codigo}}" *ngFor="let numeroMatricula of numerosMatricula">
                            {{numeroMatricula.descripcion}}
                        </option>
                    </select>
                </td>
                <td>
                    <select [(ngModel)]="detalle.jornada" class="form-control text-uppercase"
                            [disabled]="!((detalle.estado=='EN_PROCESO' || detalle.estado=='APROBADO')&&periodoLectivoSeleccionado.estado=='ACTUAL')"
                            id="jornada" name="jornada" required (change)="updateDetalleMatricula(detalle, 'Jornada')">
                        <option value="{{jornada.codigo}}" *ngFor="let jornada of jornadas">
                            {{jornada.descripcion}}
                        </option>
                    </select>
                </td>
                <td>
                    <select [(ngModel)]="detalle.tipo_matricula.id" class="form-control"
                            id="tipo_matricula" name="tipo_matricula" required
                            [disabled]="!((detalle.estado=='EN_PROCESO' || detalle.estado=='APROBADO')&&periodoLectivoSeleccionado.estado=='ACTUAL')"
                            (change)="updateDetalleMatricula(detalle,'Tipo Matricula')">
                        <option value="{{tipoMatricula.id}}" *ngFor="let tipoMatricula of tiposMatricula">
                            {{tipoMatricula.nombre}}
                        </option>
                    </select>
                </td>
                <td class="text-center">
                    {{detalle.estado}}
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-primary ml-1 btn-sm" (click)="validateDetalleCupo(detalle)"
                            title="Aprobar"
                            *ngIf="(detalle.estado=='EN_PROCESO')&&periodoLectivoSeleccionado.estado=='ACTUAL'">
                        <span class="{{messages['buttonCheck']['icon']}}"></span>
                    </button>
                    <button type="button" class="btn btn-danger ml-1 btn-sm" (click)="deleteDetalleCupo(detalle)"
                            title="Eliminar"
                            *ngIf="(detalle.estado=='EN_PROCESO' || detalle.estado=='APROBADO')&&periodoLectivoSeleccionado.estado=='ACTUAL'">
                        <span class="{{messages['buttonDelete']['icon']}}"></span>
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!--Nuevo detalle matricula-->
<ng-template #contentDetalleMatricula let-c="close" let-d="dismiss">
    <form name="cupos" method="post" #formCtrl="ngForm">
        <div class="modal-header">
            <div class="row">
                <h4 class="col-12 text-center" name="titulo">Detalle Matrícula</h4>
            </div>
        </div>
        <div class="modal-body">
            <!--Asignatura-->
            <div class="form-group row">
                <div class="col-lg-12">
                    <label for="createAsignatura">
                        <b class="text-danger">*</b> Asignatura:
                    </label>
                    <select [(ngModel)]="detalleMatriculaNuevo.asignatura.id" class="form-control text-uppercase"
                            id="createAsignatura" name="createAsignatura" required>
                        <option value="0" selected>SELECCIONE...</option>
                        <option value="{{asignatura.id}}" *ngFor="let asignatura of asignaturas">
                            {{asignatura.periodo_academico.id + ' ' + asignatura.nombre}}
                        </option>
                    </select>
                </div>
            </div>

            <!--Numero Matricula-->
            <div class="form-group row">
                <div class="col-lg-12">
                    <label for="createNumeroMatricula">
                        <b class="text-danger">*</b> Número de Matrícula:
                    </label>
                    <select [(ngModel)]="detalleMatriculaNuevo.numero_matricula" class="form-control"
                            id="createNumeroMatricula" name="createNumeroMatricula" required>
                        <option value="" selected>SELECCIONE...</option>
                        <option value="{{numeroMatricula.codigo}}" *ngFor="let numeroMatricula of numerosMatricula">
                            {{numeroMatricula.descripcion}}
                        </option>
                    </select>
                </div>
            </div>

            <!--Jornada-->
            <div class="form-group row">
                <div class="col-lg-12">
                    <label for="createJornada">
                        <b class="text-danger">*</b> Jornada:
                    </label>
                    <select [(ngModel)]="detalleMatriculaNuevo.jornada" class="form-control"
                            id="createJornada" name="createJornada" required>
                        <option value="" selected>SELECCIONE...</option>
                        <option value="{{jornada.codigo}}" *ngFor="let jornada of jornadas">
                            {{jornada.descripcion}}
                        </option>
                    </select>
                </div>
            </div>

            <!--Tipo Matricula-->
            <div class="form-group row">
                <div class="col-lg-12">
                    <label for="createTipoMatricula">
                        <b class="text-danger">*</b> Tipo de Matrícula:
                    </label>
                    <select [(ngModel)]="detalleMatriculaNuevo.tipo_matricula.id" class="form-control"
                            id="createTipoMatricula" name="createTipoMatricula" required>
                        <option value="0" selected>SELECCIONE...</option>
                        <option value="{{tipoMatricula.id}}" *ngFor="let tipoMatricula of tiposMatricula">
                            {{tipoMatricula.nombre}}
                        </option>
                    </select>
                </div>
            </div>

            <!--Paralelo-->
            <div class="form-group row">
                <div class="col-lg-12">
                    <label for="createParalelo">
                        <b class="text-danger">*</b> Paralelo:
                    </label>
                    <select [(ngModel)]="detalleMatriculaNuevo.paralelo" class="form-control"
                            id="createParalelo" name="createParalelo" required>
                        <option value="" selected>SELECCIONE...</option>
                        <option value="{{paralelo.codigo}}" *ngFor="let paralelo of paralelos">
                            {{paralelo.descripcion}}
                        </option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <h6 class="text-muted">
                <b class="text-danger">{{messages['requiredFields']['icon']}} </b>
                {{messages['requiredFields']['text']}}
            </h6>
            <button type="button" class="btn btn-success" (click)="c('save')" [disabled]="formCtrl.form.invalid">
        <span
            class="{{messages['saveConfirmationDialog']['iconOk']}}"></span>&nbsp;{{messages['saveConfirmationDialog']['ok']}}
            </button>
            <button type="button" class="btn btn-danger" (click)="c('close')">
        <span
            class="{{messages['saveConfirmationDialog']['iconCancel']}}"></span>&nbsp;{{messages['saveConfirmationDialog']['cancel']}}
            </button>
        </div>
    </form>
</ng-template>

